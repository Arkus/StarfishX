/*Copyright ©1999-2001 Mars SaxmanAll Rights ReservedThis program is free software; you can redistribute it and/ormodify it under the terms of the GNU General Public Licenseas published by the Free Software Foundation; either version 2of the License, or (at your option) any later version.This program is distributed in the hope that it will be useful,but WITHOUT ANY WARRANTY; without even the implied warranty ofMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See theGNU General Public License for more details.You should have received a copy of the GNU General Public Licensealong with this program; if not, write to the Free SoftwareFoundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.Starfish Desktop-setterSetting the desktop pattern has been the most problematic and change-prone partof the Mac implementation of Starfish from the beginning. The first approachused AppleScripts, embedded into the Starfish application itself, which drovethe appropriate control panels to select the Starfish desktop pattern. Theoriginal comment in this section contained an extended discussion of the contortions necessary to make this system work.It's a couple of years later now, and the need for contortions has not changedeven though their nature has. Apple introduced an elegant unified UI-preferenceAPI in the Theme Manager, then disembowelled it with the release of MacOS X.Once again it is necessary to jump through hoops to make things work.Under OS X, we instead use the Core Foundation preference services to manuallyreset the Finder's desktop picture preference. *//*Following is the original comment describing the AppleScript based approachand the complicated circumstances in which the different versions applied.The way to set the desktop depends on which version of MacOS you are using.The concept of a desktop picture (as opposed to the older 'ppat' style ofwallpaper) only arrives in MacOS 8.0, unless you count programs like DeskPictwhich hack picture wallpaper onto previous versions in their own idiosyncraticways. Under MacOS 8.0, 8.0.1, and later 8.1, the owner of the desktop picture isa control panel called "Desktop Picture". I have yet to determine the precisemeans by which this control panel presumably communicates with the systemdevice that loads and draws the desktop. In any case, "Desktop Picture" wascoded to accept Apple events. These are a tremendous pain to write, andinstead I opted to record an AppleScript that did the job. Thus the task ofsetting desktop wallpaper becomes one of loading and executing a script, acomparatively trivial task.This changes somewhat in MacOS 8.5 and 8.6, where the "Desktop Picture"control panel has ceased to exist. Its role is taken over by the newly expanded"Appearance" control panel, which uses a different scripting syntax to accomplishbasically the same sequence of events.Unfortunately, AppleScript is cranky, and refuses to even save as pseudocodecommands that won't execute on the host operating system. Thus it is impossibleto write a script that would detect the operating system version and talk tothe appropriate control panel, because it would always fail to compile under oneor the other of the available target systems.So we create two versions of the script: one to compile under 8.1, andthe other to compile under 8.5. We then save both scripts. The set desktopfunction's job grows slightly: it checks the MacOS version, picks the appropriatescript, and executes it.This is still not a satisfactory solution. First there are the cosmetic flaws;it's ugly and time consuming to have a control panel window flash open and closedwhen you are working. It gets in the way of your typing and is distracting. Thenthere is the nasty bug in the Appearance control panel that Apple didn't get aroundto fixing until MacOS 9, whereby the program leaks memory into the System heapevery time it is executed. Combine this with Starfish's periodic pattern switchingand you have a recipe for RAM starvation and eventual death. This is not good.It turns out that Apple introduced a device by which an application may alter thedesktop picture programatically with Appearance Manager 1.1 and newer. With alimited application of switchable themes, Starfish can set the desktop patternon its own, with no need for scripts.This is now the approach taken whenever a system carries Appearance Manager 1.1 ornewer. Since this is a programmatic approach and the functions involved are alllisted on the Carbon goodie list, I expect that the resulting code will functionproperly under MacOS 9 (something the AppleScript approach apparently fails to do)and should be usable under MacOS X Consumer as well.Unfortunately, linking against AppearanceLib's SetTheme function has the rathernasty side effect of causing the PEF loader under MacOS 8.0 and 8.1 to fail. ThusI have written a function, "MySetTheme", which loads AppearanceLib, grabs theappropriate symbol, and calls it by hand. This does exactly the same thing, albeitwith increased administrave overhead, but evades the loader problem under olderversions of MacOS.Thanks to Informer (at Talk City) for the original MacOS 8.5 and above script.Thanks also to David Blache of Metrowerks for his tweaks to the script.*/#include "setdesktop.h"#include <OSAGeneric.h>									//	mac OSA tricks#include <Components.h>#include <OSA.h>#include <AppleScript.h>#include <AEObjects.h>									//	mac OSL constants#include <Gestalt.h>#include <Resources.h>#include <Collections.h>#include <Aliases.h>#include <Appearance.h>#include <Folders.h>#include <string.h>#include <stdio.h>#define ORIGINAL_SCPT_ID 128#define APPEARANCE_SCPT_ID 129#define APPEARANCE_SYS_VERS 0x0850#ifndef __APPEARANCE__/*The following definitions should be nuked. They're from Appearance.h in thecopy of the Universal Headers that comes with CodeWarrior 5. UnfortunatelyI can't seem to find this version of UH on Apple's web site and didn't feellike spending ages looking for it, so I just copied the relevant definitionshere.kTiledOnScreen, while documented in Apple's description of switchable themes,doesn't seem to exist anywhere. I derived it by getting a theme using tiledimages and peeking at the value used for the alignment tag.*/#define kThemeDesktopPictureAliasTag 'dpal'#define kThemeDesktopPictureAlignmentTag 'dpan'enum	{	kTiledOnScreen=1,	kCenterOnScreen=2,	kFitToScreen=3,	kFillScreen=4	};#endifstatic short CalcScriptID(void);static void SetDesktopWithScript(void);static int CollectionMgrExists(long versionRequired);static int AppearanceMgrExists(long versionRequired);static int RunningOSX(void);static OSErr MySetTheme(Collection myTheme);typedef OSStatus (*SetThemeFunctionPtr)(Collection ioCollection);void SetDesktopToSavedFile(void)	{	if(CollectionMgrExists(0x01008000) && AppearanceMgrExists(0x0110))		{		OSErr err = noErr;		AliasHandle starPictFile;		SInt32 destSize = sizeof(UInt32);		UInt32 starPicAlignMode = kTiledOnScreen;		Collection starfishTheme = NewCollection();		if(starfishTheme)			{			/*			We have a usable collection. Now we need to add two components			that correspond to the Appearance Manager's theme items. These			are the desktop picture alias and the desktop picture mode.			For the picture, we'll supply an alias to starfish.pict, which is			the file the generator generated. For the mode, we'll specify 			tiling.			*/			starPictFile = FindStarfishPict();			err = AddCollectionItemHdl(starfishTheme, kThemeDesktopPictureAliasTag, 0, (Handle)starPictFile);			err = AddCollectionItem(starfishTheme, kThemeDesktopPictureAlignmentTag, 0, sizeof(UInt32), &starPicAlignMode);			/*			We're done preparing the theme. Apply it, then dispose of it.			Dispose of the alias to the picture file, too.			*/			err = SetTheme(starfishTheme);			DisposeCollection(starfishTheme);			DisposeHandle((Handle)starPictFile);			}		}	}static int RunningOSX(void)	{	long outvers;	Gestalt(gestaltSystemVersion, &outvers);	return outvers > 0x1000;	}int CollectionMgrExists(long versionRequired)	{	long collectionMgrVersion;	int exists = (Gestalt(gestaltCollectionMgrVersion, &collectionMgrVersion) == noErr);	if (exists) exists = (collectionMgrVersion >= versionRequired);	return(exists);	}int AppearanceMgrExists(long versionRequired)	{	long appearanceMgrVersion;	int exists = (Gestalt(gestaltAppearanceVersion, &appearanceMgrVersion) == noErr);	if (exists) exists = (appearanceMgrVersion >= versionRequired);	return(exists);	}void VerifySystemConfiguration(void)	{		}static OSErr MySetTheme(Collection myTheme)	{	/*	In order to avoid hard-linking against SetTheme, which is not part of the	Appearance manager in MacOS 8.0 and 8.1, SetDesktop calls this function.	We look up the appropriate function in AppearanceLib; if we can't find it,	we return an error. But that situation should never occur because there	is a version check before calling this function.	In any event, this function should operate identically to SetTheme, but the	PEF loader won't complain if SetTheme doesn't exist this way.	*/	OSErr err;	CFragConnectionID connID = 0;	SetThemeFunctionPtr destfunc;	CFragSymbolClass funcclass;	err = GetSharedLibrary("\pAppearanceLib", kCompiledCFragArch, 0, &connID, NULL, NULL);	if(err) err = GetSharedLibrary("\pCarbonLib", kCompiledCFragArch, 0, &connID, NULL, NULL);	if(!err)		{		/*		We got the library. Now see if it contains the function we need. It really		should, but it's always good to check anyway.		*/		err = FindSymbol(connID, "\pSetTheme", (Ptr*)&destfunc, &funcclass);		if(!err && destfunc && (funcclass == kTVectorCFragSymbol))			{			err = destfunc(myTheme);			}		}	return err;	}AliasHandle FindStarfishPict(void)	{	/*	Create an alias handle that points to our script file.	If this system has a "Desktop Pictures" folder, starfish.pict will	live inside it. Otherwise, starfish.pict will lay out in the open, in	the system folder itself.	*/	OSErr err = noErr;	FSSpec destfile;	AliasHandle outfile;	destfile.vRefNum = 0;	destfile.parID = 0;	err = FindFolder(kOnAppropriateDisk, kDesktopPicturesFolderType, kDontCreateFolder, &destfile.vRefNum, &destfile.parID);	if(err) err = FindFolder(kOnAppropriateDisk, kApplicationSupportFolderType, kDontCreateFolder, &destfile.vRefNum, &destfile.parID);	if(err) err = FindFolder(kOnAppropriateDisk, kSystemFolderType, kDontCreateFolder, &destfile.vRefNum, &destfile.parID);	strncpy((char*)&destfile.name[0], (char*)"\pstarfish.pict\0", 62);	destfile.name[0]--;	/*	Now that we have an FSSpec describing this file, create an alias handle to it.	This can fail in any number of interesting ways, none of which we can do much about.	*/	err = NewAliasMinimal(&destfile, &outfile);	if(err) outfile = NULL;	return outfile;	}bool DesktopPictureFileExists(void)	{	/*	Determine whether the desktop picture file exists.	Basically we construct an alias to the file, using FindStarfishPict,	then we attempt to resolve the alias. If the target does not exist,	the desktop picture file does not exist either.	*/	bool out = false;	FSSpec targetFile;	Boolean wasChangedWeDontCare;	AliasHandle starPictFile = FindStarfishPict();	if( starPictFile )		{		OSErr err = ResolveAlias( NULL, starPictFile, &targetFile, &wasChangedWeDontCare );		DisposeHandle((Handle)starPictFile);		out = err == noErr;		}	return out;	}